%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4A90D9', 'primaryTextColor': '#fff', 'primaryBorderColor': '#2E6CB5', 'lineColor': '#5C6BC0', 'secondaryColor': '#81C784', 'tertiaryColor': '#FFB74D'}}}%%

flowchart TB
    subgraph TITLE[" "]
        direction LR
        T1[" "]
    end
    
    %% ==========================================
    %% RESEARCH PHASE (Optional)
    %% ==========================================
    subgraph RESEARCH["üî¨ RESEARCH PHASE (Optional)"]
        direction TB
        
        R_START{{"--research or<br/>--full-research?"}}
        
        subgraph FULL_RESEARCH["--full-research"]
            R_ANALYST["üîç reis_analyst<br/><i>Project-level analysis</i>"]
            R_CONTEXT[("üìÑ context.md")]
            R_ANALYST --> R_CONTEXT
        end
        
        subgraph PHASE_RESEARCH["--research"]
            R_SCOUT["üîé reis_scout<br/><i>Phase-level research</i>"]
            R_RESEARCH[("üìÑ research.md")]
            R_SCOUT --> R_RESEARCH
        end
        
        R_SYNTH["üîÑ reis_synthesizer<br/><i>Combine outputs</i>"]
        R_SYNTHESIS[("üìÑ synthesis.md")]
        
        R_START -->|"--full-research"| FULL_RESEARCH
        R_START -->|"--research"| PHASE_RESEARCH
        R_CONTEXT --> R_SYNTH
        R_RESEARCH --> R_SYNTH
        R_SYNTH -->|"if multiple"| R_SYNTHESIS
    end
    
    %% ==========================================
    %% MAIN CYCLE
    %% ==========================================
    subgraph MAIN_CYCLE["üîÑ REIS CYCLE (Main Workflow)"]
        direction TB
        
        %% Planning
        subgraph PLANNING["üìã STAGE 1: PLANNING"]
            P_AGENT["üìù reis_planner<br/><i>Enhanced: reads research</i>"]
            P_INPUT1[("ROADMAP.md")]
            P_INPUT2[("PROJECT.md")]
            P_INPUT3[("research/*.md")]
            P_OUTPUT[("üìÑ PLAN.md")]
            
            P_INPUT1 --> P_AGENT
            P_INPUT2 --> P_AGENT
            P_INPUT3 -.->|"if exists"| P_AGENT
            P_AGENT --> P_OUTPUT
        end
        
        %% Review
        subgraph REVIEW["üîé STAGE 2: REVIEW"]
            RV_AGENT["‚úÖ reis_plan_reviewer<br/><i>Validate before execution</i>"]
            RV_CHECKS["Checks:<br/>‚Ä¢ Path validation<br/>‚Ä¢ Already implemented<br/>‚Ä¢ Dependencies<br/>‚Ä¢ Naming conflicts"]
            RV_OUTPUT[("üìÑ REVIEW_REPORT.md")]
            RV_SKIP{{"--skip-review<br/>or --quick?"}}
            
            RV_AGENT --> RV_CHECKS
            RV_CHECKS --> RV_OUTPUT
        end
        
        %% Execute
        subgraph EXECUTE["‚öôÔ∏è STAGE 3: EXECUTE"]
            E_AGENT["üöÄ reis_executor<br/><i>Implement changes</i>"]
            E_WAVES["Wave Execution:<br/>‚îú‚îÄ Wave 1: [T1] [T2] [T3]<br/>‚îú‚îÄ Wave 2: [T4] [T5]<br/>‚îî‚îÄ Wave 3: [T6]"]
            E_OUTPUT[("üíª Code Changes<br/>+ Git Commits")]
            
            E_AGENT --> E_WAVES
            E_WAVES --> E_OUTPUT
        end
        
        %% Verify
        subgraph VERIFY["‚úì STAGE 4: VERIFY"]
            V_AGENT["üîç reis_verifier<br/><i>Check completion</i>"]
            V_CHECKS["Checks:<br/>‚Ä¢ Deliverables exist<br/>‚Ä¢ Tests pass<br/>‚Ä¢ No syntax errors<br/>‚Ä¢ Success criteria met<br/>‚Ä¢ Feature complete (FR4.1)"]
            V_OUTPUT[("üìÑ VERIFICATION_REPORT.md")]
            
            V_AGENT --> V_CHECKS
            V_CHECKS --> V_OUTPUT
        end
        
        %% Gate
        subgraph GATE["üõ°Ô∏è STAGE 5: QUALITY GATES"]
            G_SEC["üîí Security<br/><i>Secrets, vulns</i>"]
            G_QUAL["üìä Quality<br/><i>Lint, coverage</i>"]
            G_PERF["‚ö° Performance<br/><i>Bundle, speed</i>"]
            G_A11Y["‚ôø Accessibility<br/><i>ARIA, contrast</i>"]
            G_OUTPUT[("üìÑ GATE_REPORT.md")]
            G_SKIP{{"--skip-gates<br/>or --quick?"}}
            
            G_SEC --> G_OUTPUT
            G_QUAL --> G_OUTPUT
            G_PERF --> G_OUTPUT
            G_A11Y --> G_OUTPUT
        end
        
        %% Connections
        PLANNING --> RV_SKIP
        RV_SKIP -->|"No"| REVIEW
        RV_SKIP -->|"Yes"| EXECUTE
        REVIEW --> EXECUTE
        EXECUTE --> VERIFY
        VERIFY --> G_SKIP
        G_SKIP -->|"No"| GATE
        G_SKIP -->|"Yes"| RESULT
    end
    
    %% ==========================================
    %% DEBUG LOOP
    %% ==========================================
    subgraph DEBUG_LOOP["üîß DEBUG LOOP (On Failure)"]
        direction TB
        
        D_AGENT["üêõ reis_debugger<br/><i>Analyze failure</i>"]
        D_PATTERN["Pattern Matching:<br/>‚Ä¢ Known issues<br/>‚Ä¢ Root cause analysis<br/>‚Ä¢ Solution design"]
        D_FIX[("üìÑ FIX_PLAN.md")]
        D_EXECUTOR["üî® reis_executor<br/><i>Apply fix</i>"]
        D_COUNT{{"Attempt < 3?"}}
        
        D_AGENT --> D_PATTERN
        D_PATTERN --> D_FIX
        D_FIX --> D_EXECUTOR
        D_EXECUTOR --> D_COUNT
    end
    
    %% ==========================================
    %% RESULT
    %% ==========================================
    RESULT{{"Pass?"}}
    COMPLETE["‚úÖ COMPLETE<br/><i>Phase finished!</i>"]
    FAILED["‚ùå FAILED<br/><i>Max attempts reached</i>"]
    
    %% Main flow connections
    R_START -->|"No flag"| PLANNING
    R_SYNTHESIS --> PLANNING
    R_RESEARCH -->|"no synth needed"| PLANNING
    
    GATE --> RESULT
    RESULT -->|"‚úÖ Yes"| COMPLETE
    RESULT -->|"‚ùå No"| DEBUG_LOOP
    D_COUNT -->|"Yes"| VERIFY
    D_COUNT -->|"No (max reached)"| FAILED
    
    %% ==========================================
    %% STYLING
    %% ==========================================
    classDef research fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef planning fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
    classDef review fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    classDef execute fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    classDef verify fill:#E0F7FA,stroke:#0097A7,stroke-width:2px
    classDef gate fill:#FCE4EC,stroke:#C2185B,stroke-width:2px
    classDef debug fill:#FFEBEE,stroke:#D32F2F,stroke-width:2px
    classDef success fill:#C8E6C9,stroke:#2E7D32,stroke-width:3px
    classDef failure fill:#FFCDD2,stroke:#C62828,stroke-width:3px
    classDef agent fill:#BBDEFB,stroke:#1565C0,stroke-width:2px
    classDef output fill:#FFF9C4,stroke:#F9A825,stroke-width:1px
    classDef decision fill:#E1BEE7,stroke:#8E24AA,stroke-width:2px
    
    class RESEARCH research
    class PLANNING planning
    class REVIEW review
    class EXECUTE execute
    class VERIFY verify
    class GATE gate
    class DEBUG_LOOP debug
    class COMPLETE success
    class FAILED failure
    class R_ANALYST,R_SCOUT,R_SYNTH,P_AGENT,RV_AGENT,E_AGENT,V_AGENT,D_AGENT,D_EXECUTOR agent
    class P_OUTPUT,RV_OUTPUT,V_OUTPUT,G_OUTPUT,D_FIX,R_CONTEXT,R_RESEARCH,R_SYNTHESIS,E_OUTPUT output
    class R_START,RV_SKIP,G_SKIP,RESULT,D_COUNT decision
